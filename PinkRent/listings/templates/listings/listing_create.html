{% extends "base.html" %}
{% load i18n %}
{% block title %}{% trans "create a listing at"|capfirst %} {{ block.super }}{% endblock title %}
{% block content %}
  <h1>Create a New Listing</h1>
  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {{ form.non_field_errors }}
    <div class="fieldWrapper">
        {{ form.parent_category.errors }}
        <label for="{{ form.parent_category.id_for_label }}">Parent Category:</label>
        {{ form.parent_category }}
      </div>
      <div class="fieldWrapper">
        {{ form.sub_category.errors }}
        <label for="{{ form.sub_category.id_for_label }}">Sub Category:</label>
        <select id="sub-category-filter">
          <option value="">{% trans "Select Sub-Category" %}</option>
        </select>
      </div>
    <div class="fieldWrapper">
      {{ form.picture.errors }}
      <label for="{{ form.picture.id_for_label }}">Picture:</label>
      {{ form.picture }}
    </div>
    <div class="fieldWrapper">
      {{ form.name.errors }}
      <label for="{{ form.name.id_for_label }}">Name:</label>
      {{ form.name }}
    </div>
    <div class="fieldWrapper">
      {{ form.brand.errors }}
      <label for="{{ form.brand.id_for_label }}">Brand:</label>
      {{ form.brand }}
    </div>
    <div class="fieldWrapper">
      {{ form.size.errors }}
      <label for="{{ form.size.id_for_label }}">Size:</label>
      {{ form.size }}
    </div>
    <div class="fieldWrapper">
      {{ form.quality.errors }}
      <label for="{{ form.quality.id_for_label }}">Quality:</label>
      {{ form.quality }}
    </div>
    <div class="fieldWrapper">
      {{ form.color.errors }}
      <label for="{{ form.color.id_for_label }}">Color:</label>
      {{ form.color }}
    </div>
    <div class="fieldWrapper">
      {{ form.value.errors }}
      <label for="{{ form.value.id_for_label }}">Value:</label>
      {{ form.value }}
    </div>
    <div class="fieldWrapper">
      {{ form.price.errors }}
      <label for="{{ form.price.id_for_label }}">Price:</label>
      {{ form.price }}
    </div>
    <div class="fieldWrapper">
      {{ form.description.errors }}
      <label for="{{ form.description.id_for_label }}">Description:</label>
      {{ form.description }}
    </div>
    <div class="fieldWrapper">
      {{ form.tags.errors }}
      <label for="{{ form.tags.id_for_label }}">Tags:</label>
      {{ form.tags }}
    </div>
    <button type="submit">Create Listing</button>
  </form>
  <script>
    function fetchSubcategories(parentId) {
        if (parentId) {
            fetch(`{% url 'listings:get_subcategories' %}?parent_category=` + parentId)
                .then(response => response.json())
                .then(data => {
                    const subcategorySelect = document.getElementById('sub-category-filter');
                    subcategorySelect.innerHTML = '<option value="">{% trans "Select Sub-Category" %}</option>';
                    data.subcategories.forEach(subcategory => {
                        const option = document.createElement('option');
                        option.value = subcategory.id;
                        option.textContent = subcategory.name;
                        subcategorySelect.appendChild(option);
                    });
                });
        } else {
            document.getElementById('sub-category-filter').innerHTML = '<option value="">{% trans "Select Sub-Category" %}</option>';
        }
    }

    // Add event listener to parent category dropdown
    const parentCategorySelect = document.getElementById("{{ form.parent_category.id_for_label }}");
    parentCategorySelect.addEventListener("change", function() {
        fetchSubcategories(this.value);
    });

    // Call fetchSubcategories initially
    fetchSubcategories(parentCategorySelect.value);
  </script>
{% endblock %}
